version: '3.8'

services:
  clasp:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      # LLM Provider (openai, azure, openrouter, custom)
      - PROVIDER=${PROVIDER:-openai}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}

      # Azure OpenAI
      - AZURE_API_KEY=${AZURE_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_DEPLOYMENT_NAME=${AZURE_DEPLOYMENT_NAME}
      - AZURE_API_VERSION=${AZURE_API_VERSION:-2024-02-15-preview}

      # OpenRouter
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}

      # Custom Provider
      - CUSTOM_BASE_URL=${CUSTOM_BASE_URL}
      - CUSTOM_API_KEY=${CUSTOM_API_KEY}

      # Model Configuration
      - CLASP_DEFAULT_MODEL=${CLASP_DEFAULT_MODEL:-gpt-4o}
      - CLASP_MODEL_OPUS=${CLASP_MODEL_OPUS}
      - CLASP_MODEL_SONNET=${CLASP_MODEL_SONNET}
      - CLASP_MODEL_HAIKU=${CLASP_MODEL_HAIKU}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
