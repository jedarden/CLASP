name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
        default: auto

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      should_release: ${{ steps.bump.outputs.should_release }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch all tags
        run: |
          git fetch --tags --force
          echo "Available tags:"
          git tag -l | sort -V | tail -10

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: bump
        run: |
          # Get latest tag using git tag -l (works even after history rewrite)
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"

          # Parse current version (strip 'v' prefix)
          VERSION="${LATEST_TAG#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # Determine bump type from input or commits
          BUMP_TYPE="${{ inputs.bump }}"
          if [ "$BUMP_TYPE" = "auto" ] || [ -z "$BUMP_TYPE" ]; then
            # Analyze commits since last tag
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

            if echo "$COMMITS" | grep -qiE "^(feat|feature)!:|BREAKING CHANGE"; then
              BUMP_TYPE="major"
            elif echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?:"; then
              BUMP_TYPE="minor"
            else
              # Default to patch for fix:, chore:, docs:, or any other commit
              BUMP_TYPE="patch"
            fi
          fi

          echo "Bump type: $BUMP_TYPE"

          # Calculate new version
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"

          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

          # Check if there are new commits since last tag
          COMMIT_COUNT=$(git rev-list ${LATEST_TAG}..HEAD --count 2>/dev/null || echo "1")
          if [ "$COMMIT_COUNT" = "0" ] && [ -z "${{ inputs.bump }}" ]; then
            echo "No new commits since $LATEST_TAG, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if tag already exists
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "Tag $NEW_TAG already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Create and push tag
          git tag -a "$NEW_TAG" -m "Release $NEW_VERSION"
          git push origin "$NEW_TAG"

  build:
    needs: version
    if: needs.version.outputs.should_release == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ''
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: arm64
            ext: ''
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: '.exe'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        shell: bash
        run: go build -ldflags="-s -w -X main.version=v${{ needs.version.outputs.new_version }}" -o clasp-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} ./cmd/clasp

      - uses: actions/upload-artifact@v4
        with:
          name: clasp-${{ matrix.goos }}-${{ matrix.goarch }}
          path: clasp-*

  github-release:
    needs: [version, build]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name 'clasp-*' -type f -exec cp {} release/ \;
          cd release && ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          files: release/clasp-*
          generate_release_notes: true
          draft: false

  publish-npm:
    needs: [version, github-release]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    # environment: npm-publish  # Temporarily disabled for debugging
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm to latest (requires 11.5.1+ for trusted publishing)
        run: npm install -g npm@latest

      - name: Update version
        run: npm version ${{ needs.version.outputs.new_version }} --no-git-tag-version --allow-same-version

      - name: Publish with provenance
        run: npm publish --access public
